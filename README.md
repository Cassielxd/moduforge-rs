# Moduforge

Moduforge是一个不含任何业务绑定的 计价编辑器默认实现，它可以通过扩展进行定制和扩展。 它的无业务绑定本质意味着它没有固定的业务约束，提供了完全的设计自由。可以根据业务需求进行定制。 设计思想是，通过扩展的方式与业务解耦，让编辑器可以支持任何业务，并且可以支持任何业务需求。

### Moduforge是如何工作的?

- **工作方式:** 定义基础节点和标记和约束，然后定义扩展添加行为。

  - **model:** 基础数据的定义，包括节点(Node)，标记(Mark)，约束(Schema)等。

  - **state:** 状态管理，主要负责状态的更新，插件的调度。

  - **transform:** 事务的实现，类似java 的DB事务。保证操作的原子性，保证数据的一致性。可以扩展最小的操作单元。

  - **core:** 组合model,state,transform 进一步实现编辑器的核心功能，添加并收集扩展.

### 核心组件详解

#### State 状态管理

State 是编辑器的核心状态管理组件，负责维护编辑器的整体状态。它包含以下关键特性：

- **配置管理**: 通过 `Configuration` 结构体管理编辑器的配置信息，包括插件列表、文档结构定义等
- **插件状态**: 通过 `fields_instances` 管理所有插件的状态数据
- **文档管理**: 通过 `node_pool` 管理文档的节点池
- **版本控制**: 通过 `version` 字段追踪状态变更
- **资源管理**: 通过 `resource_manager` 管理全局资源

State 提供了以下主要功能：
- 创建和初始化新的编辑器状态
- 管理插件状态
- 处理事务和状态更新
- 重新配置状态以适应新的需求

#### GlobalResourceManager 全局资源管理器

GlobalResourceManager 是编辑器运行时的全局资源管理器，负责管理所有注册的资源和状态。它包含以下关键特性：

- **资源表管理**: 通过 `ResourceTable` 管理所有注册的资源
- **Gotham状态管理**: 通过 `GothamState` 管理特定于Gotham框架的状态
- **线程安全**: 实现了 `Send` 和 `Sync` trait，确保可以在线程间安全传递和共享
- **资源清理**: 提供 `clear` 方法用于清理所有资源

GlobalResourceManager 的主要使用场景：
- 插件间共享资源
- 管理全局状态
- 处理跨插件的数据交换
- 管理编辑器运行时的全局配置

#### State 与 GlobalResourceManager 的区别

虽然 State 和 GlobalResourceManager 都涉及状态管理，但它们在职责和使用场景上有明显区别：

1. **管理范围不同**
   - State 管理编辑器的整体状态，包括文档内容、插件状态、配置等
   - GlobalResourceManager 专注于管理运行时资源和全局共享状态

2. **生命周期不同**
   - State 的生命周期与编辑器实例绑定，随编辑器的创建而创建，销毁而销毁
   - GlobalResourceManager 的生命周期更灵活，可以在不同 State 实例间共享

3. **访问方式不同**
   - State 通过事务（Transaction）进行状态更新，保证操作的原子性和一致性
   - GlobalResourceManager 提供直接的资源访问接口，适合快速读写共享资源

4. **使用场景不同**
   - State 用于管理编辑器的核心状态，如文档内容、插件配置等
   - GlobalResourceManager 用于管理跨插件共享的资源，如缓存、配置等

5. **线程安全性不同**
   - State 的状态更新是单线程的，通过事务保证一致性
   - GlobalResourceManager 是线程安全的，可以在多线程环境下安全访问

6. **扩展性不同**
   - State 的状态结构相对固定，主要围绕文档和插件
   - GlobalResourceManager 可以动态注册和管理任意类型的资源，扩展性更强

### Moduforge使用了哪些技术框架？

- **im:**  Moduforge编辑器使用im-rs进行基础数据定义，保证数据的不可变。

- **zen:** Moduforge编辑器使用zen进行规则引擎管理，解除业务硬编码耦合。

### Moduforge 框架设计思路

- **可扩展性:** Moduforge设计为高度可扩展，允许开发者根据需求自定义编辑器的功能和行为。这包括插件系统，使得添加新功能变得简单，任何功能都可以扩展.例如：历史记录，撤销，重做。

- **模块化:** 整个框架被分解成多个独立的模块，每个模块负责编辑器的一个特定方面，如模型、状态管理、命令执行等。这种设计使得开发者可以根据项目需求选择性地引入所需模块。

- **命令模式:** 使用命令模式来处理编辑操作。每个编辑操作都被封装成一个命令对象，这样可以方便地撤销或重做操作，同时也有助于实现复杂的编辑逻辑。

- **状态管理:** 编辑器的状态被集中管理，所有对文档的修改都会触发状态的变化。这种设计有助于保持数据的一致性和可预测性。

## 关于Moduforge

Moduforge,是基于当前计价软件延伸出来的，因此它与 计价 的业务无关，它只是 个大型的 的编辑器。

## License

计价软件内部团队使用请勿泄露。
