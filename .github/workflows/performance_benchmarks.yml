name: æ€§èƒ½åŸºå‡†æµ‹è¯•

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œ

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  åŸºå‡†æµ‹è¯•:
    name: è¿è¡ŒåŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        tier:
          - foundation  # åŸºç¡€å±‚: model, derive, macro
          - core-logic  # æ ¸å¿ƒé€»è¾‘å±‚: transform, expression, template  
          - service     # æœåŠ¡å±‚: state, engine, file, search, persistence
          - integration # é›†æˆå±‚: core, collaboration, collaboration_client
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºå›å½’æ¯”è¾ƒ
    
    - name: è®¾ç½®Rustå·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: é…ç½®ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: benchmark-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ matrix.tier }}
        restore-keys: |
          benchmark-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-
          benchmark-${{ runner.os }}-
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip sqlite3
        pip3 install --user pandas matplotlib scipy numpy
    
    - name: ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜ä¿¡æ¯: $(free -h)"
        echo "ç£ç›˜ç©ºé—´: $(df -h)"
        echo "Rustç‰ˆæœ¬: $(rustc --version)"
        echo "Cargoç‰ˆæœ¬: $(cargo --version)"
        echo "Pythonç‰ˆæœ¬: $(python3 --version)"
    
    - name: åˆ›å»ºç»“æœç›®å½•
      run: |
        mkdir -p benchmarks/results
        mkdir -p benchmarks/reports
    
    - name: è¿è¡ŒåŸºç¡€å±‚åŸºå‡†æµ‹è¯•
      if: matrix.tier == 'foundation'
      run: |
        echo "è¿è¡ŒåŸºç¡€å±‚åŸºå‡†æµ‹è¯•..."
        cargo bench --package moduforge-model | tee benchmarks/results/model-output.txt
        cargo bench --package moduforge-macros-derive | tee benchmarks/results/derive-output.txt
        cargo bench --package moduforge-macros | tee benchmarks/results/macro-output.txt
    
    - name: è¿è¡Œæ ¸å¿ƒé€»è¾‘å±‚åŸºå‡†æµ‹è¯•
      if: matrix.tier == 'core-logic'
      run: |
        echo "è¿è¡Œæ ¸å¿ƒé€»è¾‘å±‚åŸºå‡†æµ‹è¯•..."
        cargo bench --package moduforge-transform | tee benchmarks/results/transform-output.txt
        cargo bench --package moduforge-rules-expression | tee benchmarks/results/expression-output.txt
        cargo bench --package moduforge-rules-template | tee benchmarks/results/template-output.txt
    
    - name: è¿è¡ŒæœåŠ¡å±‚åŸºå‡†æµ‹è¯•
      if: matrix.tier == 'service'
      run: |
        echo "è¿è¡ŒæœåŠ¡å±‚åŸºå‡†æµ‹è¯•..."
        cargo bench --package moduforge-state | tee benchmarks/results/state-output.txt
        cargo bench --package moduforge-rules-engine | tee benchmarks/results/engine-output.txt
        cargo bench --package moduforge-file | tee benchmarks/results/file-output.txt
        cargo bench --package moduforge-search | tee benchmarks/results/search-output.txt
        cargo bench --package moduforge-persistence | tee benchmarks/results/persistence-output.txt
    
    - name: è¿è¡Œé›†æˆå±‚åŸºå‡†æµ‹è¯•
      if: matrix.tier == 'integration'
      run: |
        echo "è¿è¡Œé›†æˆå±‚åŸºå‡†æµ‹è¯•..."
        cargo bench --package moduforge-core | tee benchmarks/results/core-output.txt
        cargo bench --package moduforge-collaboration | tee benchmarks/results/collaboration-output.txt
        cargo bench --package moduforge-collaboration-client | tee benchmarks/results/collaboration-client-output.txt
    
    - name: æ”¶é›†åŸºå‡†æµ‹è¯•ç»“æœ
      run: |
        echo "æ”¶é›† ${{ matrix.tier }} å±‚åŸºå‡†æµ‹è¯•ç»“æœ..."
        
        # åˆ›å»ºç»“æœæ±‡æ€»JSON
        cat > benchmarks/results/${{ matrix.tier }}-summary.json << 'EOF'
        {
          "tier": "${{ matrix.tier }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_commit": "${{ github.sha }}",
          "results": []
        }
        EOF
        
        # è§£æCriterionè¾“å‡ºå¹¶ç”ŸæˆJSONç»“æœ
        python3 scripts/parse_benchmark_output.py \
          --input-dir benchmarks/results \
          --output benchmarks/results/${{ matrix.tier }}-results.json \
          --tier ${{ matrix.tier }} \
          --commit ${{ github.sha }}
    
    - name: ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results-${{ matrix.tier }}-${{ github.sha }}
        path: |
          benchmarks/results/${{ matrix.tier }}-results.json
          benchmarks/results/*-output.txt
        retention-days: 30
    
    - name: æ€§èƒ½å›å½’æ£€æµ‹
      if: github.event_name == 'pull_request'
      run: |
        echo "æ£€æŸ¥æ€§èƒ½å›å½’..."
        
        # è·å–åŸºçº¿æ•°æ®ï¼ˆä¸»åˆ†æ”¯æœ€æ–°ç»“æœï¼‰
        BASELINE_COMMIT=$(git rev-parse origin/${{ github.base_ref }})
        echo "åŸºçº¿æäº¤: $BASELINE_COMMIT"
        
        # ä¸‹è½½åŸºçº¿ç»“æœï¼ˆä»ä¸Šæ¬¡æˆåŠŸçš„CIè¿è¡Œï¼‰
        # æ³¨æ„: å®é™…å®ç°ä¸­éœ€è¦ä»artifact storageæˆ–æ•°æ®åº“è·å–
        if [ -f "benchmarks/baseline/${{ matrix.tier }}-results.json" ]; then
          echo "æ‰¾åˆ°åŸºçº¿æ•°æ®ï¼Œå¼€å§‹å›å½’æ£€æµ‹..."
          python3 scripts/performance_metrics.py detect \
            benchmarks/results/${{ matrix.tier }}-results.json \
            --threshold 10.0 \
            --baseline benchmarks/baseline/${{ matrix.tier }}-results.json \
            > benchmarks/reports/${{ matrix.tier }}-regression-report.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å›å½’
          if grep -q "ğŸš¨" benchmarks/reports/${{ matrix.tier }}-regression-report.txt; then
            echo "::warning::æ£€æµ‹åˆ°æ€§èƒ½å›å½’ï¼Œè¯·æŸ¥çœ‹æŠ¥å‘Š"
            cat benchmarks/reports/${{ matrix.tier }}-regression-report.txt
          else
            echo "âœ… æœªæ£€æµ‹åˆ°æ€§èƒ½å›å½’"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åŸºçº¿æ•°æ®ï¼Œè·³è¿‡å›å½’æ£€æµ‹"
        fi
    
    - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆ ${{ matrix.tier }} æ€§èƒ½æŠ¥å‘Š..."
        
        # åˆ›å»ºHTMLæŠ¥å‘Šæ¨¡æ¿
        cat > benchmarks/reports/${{ matrix.tier }}-report.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>ModuForge-RS ${{ matrix.tier }} å±‚æ€§èƒ½æŠ¥å‘Š</title>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; margin: 2rem; }
            .header { background: #f5f5f5; padding: 1rem; border-radius: 5px; }
            .metric { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; }
            .regression { background-color: #ffe6e6; border-color: #ff9999; }
            .improvement { background-color: #e6ffe6; border-color: #99ff99; }
            .stable { background-color: #f0f0f0; border-color: #ccc; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>ModuForge-RS ${{ matrix.tier }} å±‚æ€§èƒ½æŠ¥å‘Š</h1>
            <p>æäº¤: ${{ github.sha }}</p>
            <p>æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
            <p>åˆ†æ”¯: ${{ github.ref_name }}</p>
          </div>
          
          <div id="content">
            <!-- è¿™é‡Œä¼šè¢«Pythonè„šæœ¬å¡«å……å®é™…å†…å®¹ -->
          </div>
        </body>
        </html>
        EOF
        
        echo "æŠ¥å‘Šæ¨¡æ¿åˆ›å»ºå®Œæˆ"
    
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports-${{ matrix.tier }}-${{ github.sha }}
        path: |
          benchmarks/reports/
        retention-days: 7

  æ±‡æ€»æŠ¥å‘Š:
    name: ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š
    needs: [åŸºå‡†æµ‹è¯•]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
      
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        pip install pandas matplotlib scipy numpy jinja2
      
    - name: ä¸‹è½½æ‰€æœ‰åŸºå‡†æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
      with:
        path: benchmark-artifacts/
      
    - name: ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š..."
        
        # åˆå¹¶æ‰€æœ‰ç»“æœæ–‡ä»¶
        python3 -c "
        import json
        import glob
        import os
        
        all_results = []
        for file in glob.glob('benchmark-artifacts/**/*/results.json', recursive=True):
            if os.path.exists(file):
                with open(file) as f:
                    data = json.load(f)
                    if isinstance(data, list):
                        all_results.extend(data)
                    elif 'results' in data:
                        all_results.extend(data['results'])
        
        # ä¿å­˜åˆå¹¶ç»“æœ
        os.makedirs('reports', exist_ok=True)
        with open('reports/all-results.json', 'w') as f:
            json.dump(all_results, f, indent=2)
            
        print(f'åˆå¹¶äº† {len(all_results)} æ¡åŸºå‡†æµ‹è¯•ç»“æœ')
        "
      
    - name: ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
      run: |
        python3 scripts/generate_comprehensive_report.py \
          --input reports/all-results.json \
          --output reports/comprehensive-report.html \
          --title "ModuForge-RS ç»¼åˆæ€§èƒ½æŠ¥å‘Š" \
          --commit ${{ github.sha }}
      
    - name: ä¸Šä¼ ç»¼åˆæŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-performance-report-${{ github.sha }}
        path: reports/
        retention-days: 30
      
    - name: éƒ¨ç½²æ€§èƒ½æŠ¥å‘Šåˆ°GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        destination_dir: benchmarks/${{ github.sha }}
      
    - name: å‘é€æ€§èƒ½æŠ¥å‘Šé€šçŸ¥
      if: github.event_name == 'schedule'
      run: |
        if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          echo "å‘é€Slacké€šçŸ¥..."
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸ“Š ModuForge-RS æ¯æ—¥æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ\",
              \"attachments\": [{
                \"color\": \"good\",
                \"fields\": [{
                  \"title\": \"æŠ¥å‘Šæ—¶é—´\",
                  \"value\": \"$(date -u +%Y-%m-%d)\",
                  \"short\": true
                }, {
                  \"title\": \"æäº¤\",
                  \"value\": \"${{ github.sha }}\",
                  \"short\": true
                }, {
                  \"title\": \"æŸ¥çœ‹æŠ¥å‘Š\",
                  \"value\": \"https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/benchmarks/${{ github.sha }}/comprehensive-report.html\"
                }]
              }]
            }" \
            ${{ secrets.SLACK_WEBHOOK }}
        fi

  æ€§èƒ½åŸºçº¿æ›´æ–°:
    name: æ›´æ–°æ€§èƒ½åŸºçº¿
    needs: [æ±‡æ€»æŠ¥å‘Š]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ  
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: å®‰è£…Pythonä¾èµ–
      run: pip install pandas matplotlib scipy numpy
    
    - name: ä¸‹è½½åŸºå‡†æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
      with:
        name: comprehensive-performance-report-${{ github.sha }}
        path: current-results/
    
    - name: æ›´æ–°æ€§èƒ½åŸºçº¿
      run: |
        echo "æ›´æ–°æ€§èƒ½åŸºçº¿æ•°æ®..."
        
        # åˆ›å»ºåŸºçº¿æ•°æ®åº“
        mkdir -p benchmarks/baseline
        
        if [ -f "current-results/all-results.json" ]; then
          # å¯¼å…¥å½“å‰ç»“æœä½œä¸ºæ–°åŸºçº¿
          python3 scripts/performance_metrics.py import current-results/all-results.json \
            --db benchmarks/baseline/performance.db
          
          # ä¸ºæ¯ä¸ªåŸºå‡†æµ‹è¯•è®¾ç½®åŸºçº¿
          python3 -c "
          import json
          import subprocess
          
          with open('current-results/all-results.json') as f:
              results = json.load(f)
          
          for result in results:
              cmd = [
                  'python3', 'scripts/performance_metrics.py', 'baseline',
                  '--db', 'benchmarks/baseline/performance.db',
                  '--crate', result['crate_name'],
                  '--benchmark', result['benchmark_name'],
                  '--duration', str(result['duration_ns']),
                  '--commit', '${{ github.sha }}'
              ]
              subprocess.run(cmd, check=True)
          
          print(f'æ›´æ–°äº† {len(results)} ä¸ªåŸºå‡†æµ‹è¯•çš„åŸºçº¿')
          "
          
          echo "âœ… æ€§èƒ½åŸºçº¿æ›´æ–°å®Œæˆ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶ï¼Œè·³è¿‡åŸºçº¿æ›´æ–°"
        fi
    
    - name: æäº¤åŸºçº¿æ•°æ®
      run: |
        if [ -f "benchmarks/baseline/performance.db" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add benchmarks/baseline/
          git commit -m "æ›´æ–°æ€§èƒ½åŸºçº¿æ•°æ® (${{ github.sha }})" || exit 0
          git push
        fi